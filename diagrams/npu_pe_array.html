<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NPU - PE Array</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: white; padding: 8px; color: #333; }
        .title { text-align: center; font-size: 13px; font-weight: bold; margin-bottom: 6px; color: #222; }
        .section { border: 1.5px solid #333; border-radius: 5px; padding: 5px; margin: 6px 0; background: white; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .section-title { font-weight: bold; font-size: 9px; margin-bottom: 4px; color: #222; padding-bottom: 2px; border-bottom: 1.5px solid #666; }
        .pe-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; margin: 5px auto; max-width: 360px; }
        .pe-cell { border: 1.5px solid #666; border-radius: 3px; padding: 4px; text-align: center; background: white; }
        .pe-id { font-weight: bold; font-size: 7px; margin-bottom: 2px; color: #222; padding-bottom: 2px; border-bottom: 1px solid #ccc; }
        .pe-operation { font-size: 7px; color: #555; }
        .broadcast-labels { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; margin: 4px auto; max-width: 360px; }
        .broadcast-label { border: 1.5px solid #555; border-radius: 3px; padding: 3px; text-align: center; background: #e8f4f8; font-size: 8px; }
        .pe-internal { border: 1.5px solid #555; border-radius: 4px; padding: 5px; margin: 5px 0; background: #f5f0ff; }
        .pe-component { border: 1.5px solid #666; border-radius: 3px; padding: 4px; margin: 4px 0; background: white; }
        .component-title { font-weight: bold; font-size: 7px; margin-bottom: 2px; color: #222; padding-bottom: 2px; border-bottom: 1px solid #ccc; }
        .component-desc { font-size: 6.5px; color: #555; }
        .algorithm-box { border: 1.5px solid #555; border-radius: 4px; padding: 5px; margin: 5px 0; background: #fff8e8; }
        .algorithm-step { border-left: 2px solid #666; border-radius: 2px; padding-left: 6px; margin: 3px 0; font-size: 6.5px; color: #555; }
    </style>
</head>
<body>
    <div class="title">NPU - Processing Element Array Architecture</div>
    <div class="section">
        <div class="section-title">Outer-Product Algorithm: C = A × B</div>
        <div class="algorithm-box">
            <div class="algorithm-step"><strong>For k = 0 to 3:</strong></div>
            <div class="algorithm-step">Broadcast A[:, k] (column k of A) → a_stage1[0..3]</div>
            <div class="algorithm-step">Broadcast B[k, :] (row k of B) → b_stage1[0..3]</div>
            <div class="algorithm-step">Each PE[row][col]: acc[row][col] += a_stage1[row] × b_stage1[col]</div>
            <div class="algorithm-step">Computes: C[row][col] += A[row][k] × B[k][col]</div>
        </div>
    </div>
    <div class="section">
        <div class="section-title">4×4 PE Array Structure</div>
        <div class="broadcast-labels">
            <div class="broadcast-label">a[0]<br>↓</div>
            <div class="broadcast-label">a[1]<br>↓</div>
            <div class="broadcast-label">a[2]<br>↓</div>
            <div class="broadcast-label">a[3]<br>↓</div>
        </div>
        <div class="pe-grid">
            <div class="pe-cell"><div class="pe-id">PE[0][0]</div><div class="pe-operation">acc += a[0]×b[0]</div></div>
            <div class="pe-cell"><div class="pe-id">PE[0][1]</div><div class="pe-operation">acc += a[0]×b[1]</div></div>
            <div class="pe-cell"><div class="pe-id">PE[0][2]</div><div class="pe-operation">acc += a[0]×b[2]</div></div>
            <div class="pe-cell"><div class="pe-id">PE[0][3]</div><div class="pe-operation">acc += a[0]×b[3]</div></div>
            <div class="pe-cell"><div class="pe-id">PE[1][0]</div><div class="pe-operation">acc += a[1]×b[0]</div></div>
            <div class="pe-cell"><div class="pe-id">PE[1][1]</div><div class="pe-operation">acc += a[1]×b[1]</div></div>
            <div class="pe-cell"><div class="pe-id">PE[1][2]</div><div class="pe-operation">acc += a[1]×b[2]</div></div>
            <div class="pe-cell"><div class="pe-id">PE[1][3]</div><div class="pe-operation">acc += a[1]×b[3]</div></div>
            <div class="pe-cell"><div class="pe-id">PE[2][0]</div><div class="pe-operation">acc += a[2]×b[0]</div></div>
            <div class="pe-cell"><div class="pe-id">PE[2][1]</div><div class="pe-operation">acc += a[2]×b[1]</div></div>
            <div class="pe-cell"><div class="pe-id">PE[2][2]</div><div class="pe-operation">acc += a[2]×b[2]</div></div>
            <div class="pe-cell"><div class="pe-id">PE[2][3]</div><div class="pe-operation">acc += a[2]×b[3]</div></div>
            <div class="pe-cell"><div class="pe-id">PE[3][0]</div><div class="pe-operation">acc += a[3]×b[0]</div></div>
            <div class="pe-cell"><div class="pe-id">PE[3][1]</div><div class="pe-operation">acc += a[3]×b[1]</div></div>
            <div class="pe-cell"><div class="pe-id">PE[3][2]</div><div class="pe-operation">acc += a[3]×b[2]</div></div>
            <div class="pe-cell"><div class="pe-id">PE[3][3]</div><div class="pe-operation">acc += a[3]×b[3]</div></div>
        </div>
        <div class="broadcast-labels">
            <div class="broadcast-label">← b[0]</div>
            <div class="broadcast-label">← b[1]</div>
            <div class="broadcast-label">← b[2]</div>
            <div class="broadcast-label">← b[3]</div>
        </div>
    </div>
    <div class="section">
        <div class="section-title">Individual PE Architecture</div>
        <div class="pe-internal">
            <div class="pe-component"><div class="component-title">Multiply Unit</div><div class="component-desc">In: a_value[DATA_W-1:0], b_value[DATA_W-1:0]<br>Out: product[2×DATA_W-1:0]<br>Signed multiplication</div></div>
            <div class="pe-component"><div class="component-title">Sign Extension</div><div class="component-desc">In: product[2×DATA_W-1:0]<br>Out: product_ext[ACC_W-1:0]<br>Extends sign to ACC_WIDTH</div></div>
            <div class="pe-component"><div class="component-title">Accumulator</div><div class="component-desc">Reg: acc_out[ACC_W-1:0]<br>Op: acc_out <= acc_out + product_ext (when enable)<br>Clear: acc_out <= 0 (when clear)</div></div>
            <div class="pe-component"><div class="component-title">Control Signals</div><div class="component-desc">clear: Reset (on start)<br>enable: valid_stage1<br>clk, rst: Clock and reset</div></div>
        </div>
        <div class="algorithm-box">
            <div class="section-title" style="font-size: 8px; margin-bottom: 3px;">Accumulator Sizing Formula</div>
            <div class="algorithm-step">MIN_ACC_WIDTH = (2 × DATA_WIDTH) + ceil(log2(ARRAY_SIZE))</div>
            <div class="algorithm-step">Example (INT8, 4×4): DATA_W=8, ARRAY_SIZE=4<br>MIN_ACC_WIDTH = 16 + 2 = 18 bits<br>With EXTRA_ACC_BITS=2: ACC_WIDTH = 20 bits</div>
        </div>
    </div>
</body>
</html>
